name: Sync Team Photos to Images/teamphoto

on:
  workflow_dispatch: {}
  schedule:
    # GitHub Actions schedule uses UTC.
    # Twice daily for Sydney (AEDT, UTC+11 in Jan):
    # 09:00 Sydney ≈ 22:00 UTC (prev day)
    # 21:00 Sydney ≈ 10:00 UTC
    - cron: "0 22 * * *"
    - cron: "0 10 * * *"

permissions:
  contents: write

concurrency:
  group: sync-team-photos
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare target folder
        run: |
          mkdir -p Images/teamphoto

      - name: Download photos zip
        env:
          PHOTOS_ZIP_URL: ${{ secrets.PHOTOS_ZIP_URL }}
          PHOTOS_ZIP_BEARER: ${{ secrets.PHOTOS_ZIP_BEARER }}
        run: |
          set -e

          if [ -z "$PHOTOS_ZIP_URL" ]; then
            echo "Missing secret: PHOTOS_ZIP_URL"
            exit 1
          fi

          echo "Downloading zip..."
          if [ -n "$PHOTOS_ZIP_BEARER" ]; then
            curl -L --fail \
              -H "Authorization: Bearer $PHOTOS_ZIP_BEARER" \
              -o /tmp/photos.zip "$PHOTOS_ZIP_URL"
          else
            curl -L --fail -o /tmp/photos.zip "$PHOTOS_ZIP_URL"
          fi

          echo "Zip size:"
          ls -lh /tmp/photos.zip

      - name: Unzip and overwrite into Images/teamphoto
        run: |
          set -e
          unzip -o /tmp/photos.zip -d /tmp/photos_unzipped

          rsync -av --delete \
            --include="*/" \
            --include="*.jpg" --include="*.jpeg" --include="*.png" --include="*.webp" --include="*.gif" \
            --exclude="*" \
            /tmp/photos_unzipped/ Images/teamphoto/

      - name: Commit & push if changed
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -q .; then
            git add Images/teamphoto
            git commit -m "chore: sync team photos"
            git push
          else
            echo "No changes to commit."
          fi
